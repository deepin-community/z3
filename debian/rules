#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
# export DH_VERBOSE=1

export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_CXXFLAGS_MAINT_APPEND = -fPIC -DSIMDE_ENABLE_OPENMP -fopenmp-simd -O3

ifeq ($(DEB_HOST_ARCH),riscv64)
export DEB_LDFLAGS_MAINT_APPEND = -Wl,--no-as-needed -Wl,-latomic
endif

ifeq ($(DEB_HOST_ARCH),mips64el)
export DEB_CXXFLAGS_MAINT_APPEND += -mxgot
endif

DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)

DOPACKAGES := $(shell dh_listpackages)
WITH_JAVA := $(if $(filter libz3-jni,$(DOPACKAGES)),ON,OFF)
WITH_PYTHON := $(if $(filter python3-z3,$(DOPACKAGES)),ON,OFF)

export CCACHE_BASEDIR = $(shell pwd)

%:
	dh $@

override_dh_auto_configure:
	dh_auto_configure --buildsystem=cmake+makefile -- \
		-DCMAKE_INSTALL_PYTHON_PKG_DIR=lib/python3/dist-packages \
		-DCMAKE_BUILD_TYPE=RelWithDebInfo \
		-DZ3_BUILD_PYTHON_BINDINGS=$(WITH_PYTHON) \
		-DZ3_BUILD_DOTNET_BINDINGS=OFF \
		-DZ3_BUILD_JAVA_BINDINGS=$(WITH_JAVA)


override_dh_installdocs:
	dh_installdocs -ppython3-z3 -plibz3-java -plibz3-jni --link-doc=libz3-dev
	dh_installdocs -Npython3-z3 -Nlibz3-java -Nlibz3-jni

override_dh_installchangelogs:
	dh_installchangelogs RELEASE_NOTES.md
